#!/usr/bin/env bash
set -euo pipefail

REMOTE_HOST="ubuntu@3.36.56.15"
REMOTE_APP_DIR="/var/www/seongkohn-site"
BRANCH="main"

if [[ $# -lt 1 ]]; then
  echo "Usage: ./ship \"your commit message\""
  exit 1
fi

COMMIT_MESSAGE="$*"

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: run this from inside your git project."
  exit 1
fi

if [[ -z "$(git status --porcelain)" ]]; then
  echo "No local changes to deploy."
  exit 0
fi

echo "==> Staging changes..."
git add -A

echo "==> Committing..."
git commit -m "$COMMIT_MESSAGE"

echo "==> Pushing to GitHub (${BRANCH})..."
git push origin "$BRANCH"

echo "==> Deploying on server (${REMOTE_HOST})..."
ssh "$REMOTE_HOST" "cd ${REMOTE_APP_DIR} && bash deploy.sh"

echo "==> Done. Your latest commit is live."
